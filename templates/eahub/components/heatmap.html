{% block map %}
<style>
    #map {
        height: 400px;
        border-radius: 5px;
    }
</style>

<div id="map"></div>
<script>var isIE = false;</script><!--[if IE]><script>isIE = true;</script><![endif]-->
<script>

    function initMap() {
      var minClusterZoom = 14;
      var mapOptions = {
          // How zoomed in you want the map to start at (always required)
          zoom: 11,
          maxZoom: minClusterZoom+1,
          // The latitude and longitude to center the map (always required)
          center: new google.maps.LatLng(51.5074, 0.1278), // london
          mapTypeControl: false,
          scaleControl: false,
          streetViewControl: false,
          rotateControl: false,
          // How you would like to style the map.
          // Snazzpy maps style: pale
          styles: [{"featureType":"administrative","elementType":"labels.text.fill","stylers":[{"color":"#6195a0"}]},{"featureType":"administrative.province","elementType":"geometry.stroke","stylers":[{"visibility":"off"}]},{"featureType":"landscape","elementType":"geometry","stylers":[{"lightness":"0"},{"saturation":"0"},{"color":"#f5f5f2"},{"gamma":"1"}]},{"featureType":"landscape.man_made","elementType":"all","stylers":[{"lightness":"-3"},{"gamma":"1.00"}]},{"featureType":"landscape.natural.terrain","elementType":"all","stylers":[{"visibility":"off"}]},{"featureType":"poi","elementType":"all","stylers":[{"visibility":"off"}]},{"featureType":"poi.park","elementType":"geometry.fill","stylers":[{"color":"#bae5ce"},{"visibility":"on"}]},{"featureType":"road","elementType":"all","stylers":[{"saturation":-100},{"lightness":45},{"visibility":"simplified"}]},{"featureType":"road.highway","elementType":"all","stylers":[{"visibility":"simplified"}]},{"featureType":"road.highway","elementType":"geometry.fill","stylers":[{"color":"#fac9a9"},{"visibility":"simplified"}]},{"featureType":"road.highway","elementType":"labels.text","stylers":[{"color":"#4e4e4e"}]},{"featureType":"road.arterial","elementType":"labels.text.fill","stylers":[{"color":"#787878"}]},{"featureType":"road.arterial","elementType":"labels.icon","stylers":[{"visibility":"off"}]},{"featureType":"transit","elementType":"all","stylers":[{"visibility":"simplified"}]},{"featureType":"transit.station.airport","elementType":"labels.icon","stylers":[{"hue":"#0a00ff"},{"saturation":"-77"},{"gamma":"0.57"},{"lightness":"0"}]},{"featureType":"transit.station.rail","elementType":"labels.text.fill","stylers":[{"color":"#43321e"}]},{"featureType":"transit.station.rail","elementType":"labels.icon","stylers":[{"hue":"#ff6c00"},{"lightness":"4"},{"gamma":"0.75"},{"saturation":"-68"}]},{"featureType":"water","elementType":"all","stylers":[{"color":"#eaf6f8"},{"visibility":"on"}]},{"featureType":"water","elementType":"geometry.fill","stylers":[{"color":"#c7eced"}]},{"featureType":"water","elementType":"labels.text.fill","stylers":[{"lightness":"-49"},{"saturation":"-53"},{"gamma":"0.79"}]}]
      };

        var mapElement = document.getElementById('map');
        var map = new google.maps.Map(mapElement, mapOptions);
        var iw = new google.maps.InfoWindow();

        var oms = new OverlappingMarkerSpiderfier(map, {
          markersWontMove: true,
          markersWontHide: true,
          basicFormatEvents: true
        });

        oms.addListener('click', function(marker) {
          iw.setContent(marker.desc);
          iw.open(map, marker);
        });

        var markers = locations.map(function(location, i) {
            var marker = new google.maps.Marker({
                position: location,
                optimized: !isIE  // makes SVG icons work in IE
            });
            var iconSize = new google.maps.Size(23, 32);
            marker.setIcon({
             url: '/static/imgs/marker.svg',
             size: iconSize,
             scaledSize: iconSize  // makes SVG icons work in IE
            });
            marker.desc = "<a href='" + location.link + "'>" + location.label + "</a>";
            oms.addMarker(marker);
            return marker;
        });

        // Add a marker clusterer to manage the markers.
        var markerCluster = new MarkerClusterer(
            map, markers,{imagePath: '../static/heatmap/m', maxZoom: minClusterZoom}
        );
        // prevent map from zooming in too much when clicking on cluster
        google.maps.event.addListener(markerCluster, 'clusterclick', function(cluster) {
          map.fitBounds(cluster.getBounds());
          if( map.getZoom() > minClusterZoom+1 ) {
            map.setZoom(minClusterZoom+1);
          }
        });
    }
    var locations = [
        {{ map_data | safe}}
    ]
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/OverlappingMarkerSpiderfier/1.0.3/oms.min.js"></script>
<script src="\static/heatmap/markerclusterer.js"></script>
<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDLtS7sdF1wauFJa1feNmGLlTAJI8VBokI&callback=initMap"></script>
{% endblock %}
